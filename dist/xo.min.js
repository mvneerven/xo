!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";class Emitter{constructor(e){this.obj=e,this.eventTarget=document.createDocumentFragment(),["addEventListener","dispatchEvent","removeEventListener"].forEach(this.delegate,this)}delegate(e){this.obj[e]=this.eventTarget[e].bind(this.eventTarget)}}class Core{static operatorTable={">":(e,t)=>e>t,"<":(e,t)=>e<t,">":(e,t)=>e>=t,"<=":(e,t)=>e<=t,"===":(e,t)=>e===t,"!==":(e,t)=>e!==t,"==":(e,t)=>e==t,"!=":(e,t)=>e!=t,"&":(e,t)=>e&t,"^":(e,t)=>e^t,"&&":(e,t)=>e&&t};static addEvents(e){new Emitter(e)}static compare(e,t,r){return this.operatorTable[e](t,r)}static stringifyJSONWithCircularRefs(e){var t=[],r=JSON.stringify(e,((e,r)=>{if("object"==typeof r&&null!==r){if(t.includes(r))return;t.push(r)}return r}),2);return t=null,r}static toPascalCase(e){return"string"!=typeof e?e:e.replace(/(\w)(\w*)/g,(function(e,t,r){return t.toUpperCase()+r.toLowerCase()}))}static prettyPrintJSON(e){return JSON.stringify(e,null,3).replace(/&/g,"&amp;").replace(/\\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/^( *)("[\w]+": )?("[^"]*"|[\w.+-]*)?([,[{])?$/gm,(function(e,t,r,o,a){var n=t||"";return r&&(n=n+'<span class="json-key" style="color: brown">'+r.replace(/[": ]/g,"")+"</span>: "),o&&(n=n+('"'==o[0]?'<span class="json-string" style="color: olive">':'<span class="json-value" style="color: navy">')+o+"</span>"),n+(a||"")}))}static guid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}static async waitFor(e,t){return new Promise(((r,o)=>{let a=new Date,n=setInterval((function(){e()?(console.log("resolved after",new Date-a,"ms"),clearInterval(n),r()):new Date-a>t&&(console.log("rejected after",new Date-a,"ms"),clearInterval(n),o())}),20)}))}static isValidUrl(e){let t;try{t=new URL(e)}catch(e){return!1}return"http:"===t.protocol||"https:"===t.protocol}}class DragDropSorter{constructor(e,t,r){Core.addEvents(this),this.masterContainer=e,this.selector=t,this.childSelector=r,this.dragSortContainers=e.querySelectorAll(t),console.debug("dragSortContainers selected for dragdrop sorting: "+this.dragSortContainers.length,", selector: ",t),this.enableDragList(e,r)}triggerEvent(e,t){console.debug("Triggering event",e,"detail: ",t);let r=new Event(e);r.detail=t,this.dispatchEvent(r)}on(e,t){return console.debug("Listening to event",e,t),this.addEventListener(e,t),this}enableDragList(e,t){let r=e.querySelectorAll(t);console.debug("Elements selected for dragdrop sorting: "+r.length,", childSelector: ",t),r.forEach((e=>{this.enableDragItem(e)}))}enableDragItem(e){e.setAttribute("draggable",!0),e.ondrag=e=>{this.handleDrag(e)},e.ondragend=e=>{this.handleDrop(e)}}handleDrag(e){const t=e.target,r=t.closest(this.selector),o=e.clientX,a=e.clientY;t.classList.add("drag-sort-active");let n=t.closest(this.selector);n&&(n.classList.add("drag-sort-in-process"),console.debug("drag starts: "+t.class,", container:",n.class));let s=null===document.elementFromPoint(o,a)?t:document.elementFromPoint(o,a);r===s.parentNode&&(s=s!==t.nextSibling?s:s.nextSibling,r.insertBefore(t,s))}handleDrop(e){e.target.classList.remove("drag-sort-active"),console.debug("drag stopped: "+e.target.class);let t=e.target.closest(this.selector);t&&(console.debug("Sort container: "+t.class),t.classList.remove("drag-sort-in-process")),this.triggerEvent("sort",{order:this.getOrder()})}getOrder(){return[]}destroy(){this.masterContainer.querySelectorAll("[draggable]").forEach((e=>{e.draggable=!1,e.ondrag=null,e.ondragend=null}))}}class DOM{static DragDropSorter=DragDropSorter;static _staticConstructor=function(){DOM.setupGrid()}();static parseHTML(e){return(new DOMParser).parseFromString(e,"text/html").body.firstChild}static getValue(e){if(DOM._checkNull("getValue",e),"select"===e.type||"select-one"===e.type)return-1!==e.selectedIndex?e.options[e.selectedIndex].value:void 0;if("radio"===e.type){let t=e.closest('[data-name="'+e.name+'"]').querySelector(":checked");return t?t.value:void 0}return e.value}static setValue(e,t){DOM._checkNull("setValue",e),e.value=t}static elementPath(e){return e.toString()}static elementToString(e){DOM._checkNull("elementToString",e);let t=[];return e&&e.nodeName&&t.push(e.nodeName),e.id&&t.push("#",e.id),e.classList&&e.classList.length&&(t.push("."),t.push(Array(e.classList).join("."))),t.join("")}static _checkNull(e,t){}static hide(e){DOM._checkNull("hide",e),e.style.display="none"}static show(e){DOM._checkNull("show",e),e.style.display="block"}static enable(e){DOM._checkNull("enable",e),e.removeAttribute("disabled")}static disable(e){DOM._checkNull("disable",e),e.setAttribute("disabled","disabled")}static trigger(e,t,r){DOM._checkNull("trigger",e);let o=new Event(t);o.detail=r,e.dispatchEvent(o)}static throttleResize(e,t){DOM._checkNull("throttleResize",e);let r;t(),e.addEventListener("resize",(e=>{clearTimeout(r),r=setTimeout(t,100)}))}static changeHash(e){history.replaceState(null,null,document.location.pathname+"#"+e)}static prettyPrintHTML(e){var t=document.createElement("div");return t.innerHTML=e.trim(),DOM.formatHTMLNode(t,0).innerHTML.trim()}static formatHTMLNode(e,t){for(var r,o=new Array(1+t++).join("  "),a=new Array(t-1).join("  "),n=0;n<e.children.length;n++)r=document.createTextNode("\n"+o),e.insertBefore(r,e.children[n]),DOM.formatHTMLNode(e.children[n],t),e.lastElementChild==e.children[n]&&(r=document.createTextNode("\n"+a),e.appendChild(r));return e}static setupGrid(){const e=document.querySelector("HTML");DOM.throttleResize(window,(t=>{((t,r)=>{const o="nsp-",a={xs:768,sm:992,md:1200,lg:1440,xl:1920,uw:2300};var n="nsp-xs";for(var s in a)e.classList.remove(o+s),t>a[s]&&(n=o+s);e.classList.remove("nsp-portrait"),e.classList.remove("nsp-landscape"),e.classList.add(t>r?"nsp-landscape":"nsp-portrait"),e.classList.add(n)})(window.innerWidth,window.innerHeight)}))}static parseCSS(e){let t=document.implementation.createHTMLDocument(""),r=document.createElement("style");return r.textContent=e,t.body.appendChild(r),r.sheet.cssRules}static waitFor(e,t){return t||(t=1e3),Core.waitFor((()=>document.querySelector(e)),t)}static require(e,t){"string"==typeof e&&(e=[e]);var r=document;let o=0;return new Promise(((a,n)=>{e.forEach((n=>{let s=r.createElement("script");s.src=n,r.head.appendChild(s),s.onload=r=>{o++,o===e.length&&("function"==typeof t&&t(),a())}}))}))}static addStyleSheet(e,t){var r=document;if(r.querySelector("head > link[rel=stylesheet][href='"+e+"']"))return;let o=r.createElement("link");if(o.rel="stylesheet",o.href=e,t)for(var a in t)o.setAttribute(a,t[a]);r.head.appendChild(o)}static getObjectValue(e,t,r){t=DOM.stringToPath(t);for(var o=e,a=0;a<t.length;a++){if(!o[t[a]])return r;o=o[t[a]]}return o}static format(e,t,r){if(r=r||{empty:""},e="function"==typeof e?e():e,-1===["string","number"].indexOf(typeof e))throw"Placeholders: please provide a valid template";return t?e=e.replace(/\{\{([^}]+)\}\}/g,(function(e){e=e.slice(2,-2);var o=DOM.getObjectValue(t,e.trim());return o||(void 0!==r.empty?r.empty:"{{"+e+"}}")})):e}static stringToPath(e){if("string"!=typeof e)return e;var t=[];return e.split(".").forEach((function(e){e.split(/\[([^}]+)\]/g).forEach((function(e){e.length>0&&t.push(e)}))})),t}static replace(e,t){let r=e;return r.parentNode.insertBefore(t,r),r.remove(),t}static unwrap(e){for(var t=e.parentNode;e.firstChild;)t.insertBefore(e.firstChild,e);return t.removeChild(e),t}static copyToClipboard(e){const t=window.getSelection(),r=document.createRange();r.selectNodeContents(e),t.removeAllRanges(),t.addRange(r);const o=document.execCommand("copy");return window.getSelection().removeAllRanges(),o}static maskInput(e,t){t.pattern,t.mask;const r=(e,t,r)=>{for(var o=e.replace(/[^0-9]/g,"").split(""),a=0,n="",s=0;s<t.length;s++){const e=t[s];o[a]?/\*/.test(e)?(n+=o[a],a++):n+=e:r&&r.split("")[s]&&(n+=r.split("")[s])}return n},o=e=>{const t=r(e.value,e.getAttribute("data-format"));if(e.value=r(e.value,e.getAttribute("data-format"),e.getAttribute("data-mask")),e.createTextRange){var o=e.createTextRange();o.move("character",t.length),o.select()}else e.selectionStart&&(e.focus(),e.setSelectionRange(t.length,t.length))};e.addEventListener("keyup",(function(){o(e)})),e.addEventListener("keydown",(function(){o(e)})),o(e)}}
/*!
     * ExoForm - Generic Form/Wizard Generator - using JSON Form Schemas
     * (c) 2021 Marc van Neerven, MIT License, https://cto-as-a-service.nl 
    */class ExoForm{static meta={properties:{all:["accept","alt","autocomplete","autofocus","capture","checked","dirName","disabled","height","list","max","maxLength","min","minLength","multiple","name","pattern","placeholder","readOnly","required","size","src","step","type","value","width","className"],map:{class:"className",readonly:"readOnly",dirname:"dirName",minlength:"minLength",maxlength:"maxLength"},reserved:["containerClass","caption","template","elm","ctl","tagname"]},templates:{empty:'<span data-replace="true"></span>',exocontainer:'<div class="exf-container"></div>',default:'<div data-id="{{id}}" class="exf-ctl-cnt {{class}}"><label title="{{caption}}">{{caption}}</label><span data-replace="true"></span></div>',nolabel:'<div data-id="{{id}}" class="exf-ctl-cnt {{class}}"><span data-replace="true"></span></div>',text:'<div data-id="{{id}}" class="exf-ctl-cnt exf-base-text {{class}}"><span data-replace="true"></span><label title="{{caption}}">{{caption}}</label></div>',labelcontained:'<div data-id="{{id}}" class="exf-ctl-cnt {{class}}"><label title="{{tooltip}}"><span data-replace="true"></span> <span>{{caption}}</span></label></div>',form:'<form class="exf-form {{class}}" method="post"></form>',static:'<div class="{{class}}" ></div>',fieldset:'<fieldset data-page="{{pagenr}}" data-pageid="{{pageid}}" class="exf-cnt {{class}}"></fieldset>',legend:'<legend class="exf-page-title">{{legend}}</legend>',pageIntro:'<p class="exf-page-intro">{{intro}}</p>',datalist:'<datalist id="{{id}}"></datalist>',datalistItem:'<option label="{{label}}" value="{{value}}" >',button:'<button name="{{name}}" type="{{type}}" class="btn {{class}}">{{caption}}</button>'}};static _staticConstructor=(()=>{ExoForm.setup()})();static setup(){}static version="0.98";defaults={type:"form",baseUrl:document.location.origin,navigation:"default",runtime:{progress:!1},form:{theme:"fluent",class:""},multiValueFieldTypes:["checkboxlist","tags"],ruleMethods:{visible:[Field.show,Field.hide],enabled:[Field.enable,Field.disable],scope:[Page.scope,Page.descope],customMethod:[Field.callCustomMethod,()=>{}],goto:[Page.goto,()=>{}],dialog:[Dialog.show,()=>{}]}};constructor(e,t){const r=this;if(Core.addEvents(this),!(e&&e instanceof ExoFormFactory.Context))throw"Invalid instantiation of ExoForm: need ExoFormContext instance";r.context=e,t=t||{};r.options={type:"form",customMethods:{},...t},r.formSchema={...r.defaults},r.form=DOM.parseHTML(DOM.format(ExoForm.meta.templates[r.options.type],{...r.formSchema.form||{class:""}})),r.container=DOM.parseHTML(ExoForm.meta.templates.exocontainer)}load(e){const t=this;return new Promise(((r,o)=>{const a=e=>{if(e){t.rawSchema=JSON.stringify(e,null,2),t.formSchema={...t.defaults,...e},t.triggerEvent(ExoFormFactory.events.schemaLoaded),t.formSchema.totalFieldCount=t.getTotalFieldCount(t.formSchema),t.applyLoadedSchema();let o=ExoFormFactory.navigation[t.formSchema.navigation];t.navigation=new o(t),console.debug("Navigation type:",t.formSchema.navigation,o.name),r(t)}else r(t)};if("object"==typeof e)a(e);else try{e=new URL(e,this.formSchema.baseUrl),fetch(e).then((e=>e.json())).then((e=>{a(e)})).catch((e=>{o(e)}))}catch(e){o(e)}}))}applyLoadedSchema(){const e=this;e.formSchema.form=e.formSchema.form||{theme:e.defaults.form.theme},(e.formSchema.form.theme?e.formSchema.form.theme.split(" "):[e.defaults.form.theme]).forEach((t=>{e.container.classList.add(t)})),(e.formSchema.form.class?e.formSchema.form.class.split(" "):["standard"]).forEach((t=>{e.form.classList.add(t)}))}triggerEvent(e,t,r){console.debug("Triggering event",e,"detail: ",t),r||(r=new Event(e,{bubbles:!1,cancelable:!1})),r.detail={exoForm:this,...t||{}},this.dispatchEvent(r)}getTotalFieldCount(e){let t=0;return e&&e.pages&&0!==e.pages.length?(e.pages.forEach((e=>{e&&e.fields&&(t+=e.fields.length)})),t):0}isPageValid(e){const t=this;let r=!1;try{t.runValidCheck=!0,t.form.querySelectorAll('[data-page="'+e+'"] .exf-ctl-cnt [name]').forEach((e=>{e.reportValidity()||(r=!0),r||e.required&&""==t.getFieldValue(e)&&(r=!0)}))}finally{t.runValidCheck=!1}return!r}getField(e){return this.findField((t=>t.name===e))}findField(e){const t=this;let r=null;for(var o in t.formSchema.pages){if(r=t.formSchema.pages[o].fields.find(e),r)break}return r}renderForm(){const e=this;return e.triggerEvent(ExoFormFactory.events.renderStart),e.cleanup(),new Promise(((t,r)=>{if(!e.formSchema||!e.formSchema.pages||null==e.formSchema.pages.length)throw"Invalid ExoForm schema";e.container.appendChild(e.form),e.container.classList.add("exf-ver-"+ExoForm.version);try{e.renderPages().then((()=>{e.finalizeForm(),t(e)})).catch((e=>{r("renderPages() failed: "+e.toString())}))}catch(e){r("Exception in renderPages(): "+e.toString())}}))}finalizeForm(){const e=this;console.debug("Finalizing form, rendering is ready"),e.navigation.render(),e.form.addEventListener("submit",(t=>{t.preventDefault(),t.stopPropagation(),e.submitForm(t)})),e.form.addEventListener("change",(e=>{e.stopPropagation()})),e.checkRules(),e.updateView(0),e.triggerEvent(ExoFormFactory.events.renderReady),new IntersectionObserver(((t,r)=>{e.container.offsetHeight&&(console.debug("Form is now interactive"),e.triggerEvent(ExoFormFactory.events.interactive))}),{root:document.documentElement}).observe(e.container)}cleanup(){this.navigation.clear(),this.container&&(this.container.innerHTML="")}on(e,t){return console.debug("Listening to event",e,t),this.addEventListener(e,t),this}renderPages(){const e=this;return new Promise(((t,r)=>{var o=0;e.form.setAttribute("data-current-page",o+1);let a=0;e.pageContainer=DOM.parseHTML('<div class="exf-wrapper" />'),e.formSchema.pages.forEach((n=>{o++,n=e.enrichPageSettings(n,o),e.pageContainer.appendChild(n.dummy),e.createControl(n).then((s=>{let i=0;n.fields.forEach((l=>{console.debug("Rendering field",l.name,l),l.dummy=DOM.parseHTML("<span/>"),s.appendChild(l.dummy),e.createControl(l).then((()=>{l._control.render().then((e=>{if(!e)throw ExoFormFactory.fieldToString(l)+" does not render an HTML element";i=this._addRendered(l,e,i,n,s)})).catch((e=>{let t=DOM.parseHTML(DOM.format('<span class="exf-error exf-render-error" title="{{title}}">ERROR</span>',{title:"Error rendering field "+ExoFormFactory.fieldToString(l)+": "+e.toString()}));i=this._addRendered(l,t,i,n,s)})).finally((r=>{if(a++,a===e.formSchema.totalFieldCount)if(e.container.classList.add(o>1?"exf-multi-page":"exf-single-page"),e.formSchema.form.container){let r=e.getFormContainerProps(e);e.createControl(r).then((r=>{r.render().then((o=>{o.appendChild(e.pageContainer),e.pageContainer=DOM.unwrap(e.pageContainer),r.finalize(e.pageContainer),e.form.appendChild(o),t()}))}))}else e.form.appendChild(e.pageContainer),t()}))})).catch((e=>{r("Exception in createControl() for control "+ExoFormFactory.fieldToString(l)+": "+e.toString())}))}))})).catch((e=>{r("Exception in createControl() for page container "+ExoFormFactory.fieldToString(n)+": "+e.toString())}))}))}))}_addRendered(e,t,r,o,a){return DOM.replace(e.dummy,t),delete e.dummy,++r===o.fields.length&&(console.debug("Page "+o.pagenr+" rendered with "+r+" controls"),a.render().then((e=>{DOM.replace(o.dummy,e),delete o.dummy}))),r}getFormContainerProps(){return{type:"div",class:"exf-wrapper",...this.formSchema.form.container,pages:this.formSchema.pages.map((e=>({id:"page"+e.id,caption:e.legend})))}}enrichPageSettings(e,t){return e.index=t,console.debug("Rendering page "+e.index),e.isPage=!0,e.type=e.type||"fieldset",e.pagenr=t,e.pageid=e.id||"page"+t,e.class="exf-cnt exf-page"+(e.class?" "+e.class:""),e.dummy=DOM.parseHTML("<span/>"),e}map(e){return this.formSchema.pages.forEach((t=>{t.fields.forEach((t=>{let r=e(t);if(void 0!==r&&(t.value=r,t._control&&t._control.htmlElement)){let e=t._control.htmlElement;t._control.setCurrentValue?t._control.setCurrentValue(t.value):e.value=t.value||""}}))})),this}showFirstInvalid(){const e=this;let t=e.form.querySelectorAll(".exf-page:not([data-skip='true']) :invalid");if(console.debug("Invalid controls",t),t&&t.length){const r=()=>{t[0].focus(),t[0].reportValidity(),DOM.trigger(t[0],"change")};if(null===t[0].offsetParent){let o=t[0].closest("[data-page]");if(o){let t=parseInt(o.getAttribute("data-page"));e.updateView(0,t),setTimeout((e=>r),20)}}else r();return!0}}submitForm(e){const t=this;e&&e.preventDefault(),t.showFirstInvalid()||(t.form,t.getFormValues(e).then((e=>{t.triggerEvent(ExoFormFactory.events.post,{postData:e})})))}getFormValues(e){const t=this,r={};return new Promise(((e,o)=>{let a=Object.fromEntries(new FormData(t.form));t.formSchema.pages.forEach((e=>{e.fields.forEach((e=>{e.getCurrentValue?r[e.name]=e.getCurrentValue():(r[e.name]=a[e.name],r[e.name]=ExoFormFactory.checkTypeConversion(e.type,r[e.name]))}))})),console.debug("Form data to post",r),e(r)}))}getFieldValue(e){return e&&e.getCurrentValue?e.getCurrentValue():e.name?DOM.getValue(this.form.querySelector("[name='"+e.name+"']")):void 0}gotoPage(e){return this.updateView(0,e)}nextPage(){this.updateView(1)}previousPage(){this.updateView(1)}updateView(e,t){const r=this;t=t||1,0!==e&&(t=parseInt(r.form.getAttribute("data-current-page")||"0")),t=r.getNextPage(e,t);let o=r.getLastPage();r.form.setAttribute("data-current-page",t),r.form.setAttribute("data-page-count",r.formSchema.pages.length),r.currentPage=t;let a=0;return r.form.querySelectorAll(".exf-page[data-page]").forEach((e=>{a++,e.classList[a===t?"add":"remove"]("active")})),r.navigation.update(),r.triggerEvent(ExoFormFactory.events.page,{page:t,pageCount:o}),t}getNextPage(e,t){const r=this;let o=!1;var a;do{if((t+=e)>r.formSchema.pages.length)return;let n=r.form.querySelector('.exf-page[data-page="'+t+'"]');if(!n)return void(o=!0);if(a="true"===n.getAttribute("data-skip"),console.debug("Wizard Page "+t+" currently "+(a?"OUT OF":"in")+" scope"),a||(o=!0),0===e)break}while(!o);return t<1&&(t=1),t}getLastPage(){const e=this;let t=parseInt(e.form.getAttribute("data-current-page")),r=0,o=-1;do{o=e.getNextPage(1,t),o&&(r=o,t=o)}while(o);return r||t||1}focusFirstControl(){var e=this.form.querySelector(".exf-page.active .exf-ctl-cnt");e&&null!==e.offsetParent&&(e.closest(".exf-page").scrollIntoView(),setTimeout((t=>{let r=e.querySelector("[name]");r&&r.offsetParent&&r.focus()}),20))}async renderSingleControl(e){let t=await this.createControl(e);e._control=t;let r=await e._control.render();if(!r)throw ExoFormFactory.fieldToString(e)+" does not render an HTML element";return r}createControl(e){const t=this;return new Promise(((r,o)=>{const a=(e,t)=>{e._control=t,t.htmlElement.data=t.htmlElement.data||{},t.htmlElement.data.field=e,t.htmlElement.setAttribute("data-exf","1"),console.debug("Resolving ",ExoFormFactory.fieldToString(e)),r(t)};try{if(!e||!e.type)throw"Incorrect field options. Must be object with at least 'type' property. "+JSON.stringify(e);e.id=e.id||Core.guid();let r=t.context.get(e.type);if(!r)throw e.type+" is not a registered ExoForm field type";let o=r.type;if(!o)throw"Class for "+e.type+" not defined";if(!t.context.isExoFormControl(e))throw"Cannot create control: class for "+e.type+" is not derived from ExoControlBase";let n=null,s={exo:t,field:e};e.custom?ExoFormFactory.loadCustomControl(e,e.custom).then((t=>{let r=t.default;n=new r(s),a(e,n)})):(n=new o(s),a(e,n))}catch(r){let o=new(t.context.get("div").type)({exo:t,field:{...e}});o.htmlElement.appendChild(DOM.parseHTML(DOM.format('<span class="exf-error exf-create-error" title="{{title}}">ERROR</span>',{title:"Error creating "+ExoFormFactory.fieldToString(e)+": "+r.toString()}))),a(e,o)}}))}testValidity(e,t){this.runValidCheck&&e.preventDefault()}checkRules(){const e=this;"form"===e.options.type&&e.formSchema.pages.forEach((t=>{Array.isArray(t.rules)&&(console.debug("Checking page rules",t),t.rules.forEach((r=>{Array.isArray(r.expression)&&e.interpretRule("page",t,r)}))),t.fields.forEach((t=>{Array.isArray(t.rules)&&(console.debug("Checking field rules",t),t.rules.forEach((r=>{Array.isArray(r.expression)&&e.interpretRule("field",t,r)})))}))}))}getRenderedControl(e){return this.form.querySelector('[data-id="'+e+'"]')}getFieldFromElementId(e){var t=this.getRenderedControl(e);return ExoFormFactory.getFieldFromElement(t)}interpretRule(e,t,r){const o=this;let a=ExoFormFactory.fieldToString(t);if(console.debug("Running rule on "+a+" -> [",r.expression.join(", ")+"]"),5===r.expression.length){let e=o.formSchema.ruleMethods[r.type];if(e){let n=o.getRenderedControl(r.expression[0]);if(n){let s=n.querySelector("[name]");if(s||(s=n),s){console.debug("Dependency control for rule on '"+a+"': ",s.name);const n=i=>{console.debug("Event '"+r.expression[1]+"' fired on ",DOM.elementPath(i));let l=r.expression.slice(2,5),c=o.testRule(t,s,...l);console.debug("Rule",l,"matched: ",c);const d=e[c?0:1];console.debug("Applying rule",r.expression[1],a),d.apply(t._control.htmlElement,[{event:i,field:t,exoForm:o,rule:r,dependency:s}]);let u=o.getEventHost(s);o.setupEventEventListener({field:t,host:u,rule:r,eventType:r.expression[1],method:n})};n({target:s})}else console.error("Dependency control for rule on '"+a+"' not found")}else console.warn("Dependency field for",t,"not found with id '"+r.expression[0]+"'")}else console.error("Rule method for rule type",r.type,"on field",t)}}setupEventEventListener(e){"livechange"===e.eventType&&(e.eventType="input"),console.debug("Setting up event listener of type '"+e.eventType+"' on ",DOM.elementToString(e.host)),e.host.addEventListener(e.eventType,e.method)}getEventHost(e){return e.closest('[data-evtarget="true"]')||e}testRule(f,control,value,compare,rawValue){var t=void 0;let v=this.getFieldValue(control);try{t=eval(rawValue)}catch(e){throw console.error("Error evaluating rule control value for ",control,compare,v,rawValue),"Error evaluating "+rawValue}return console.debug("Value of '"+control.name+"' =",v),Core.compare(compare,v,t)}clear(){this.form.reset(),this.form.querySelectorAll(".clearable").forEach((e=>{e.innerHTML=""}))}}class Field{static show(e){DOM.show(e.field._control.container)}static hide(e){DOM.hide(e.field._control.container)}static enable(e){DOM.enable(e.field._control.htmlElement)}static disable(e){DOM.disable(e.field._control.htmlElement)}static callCustomMethod(e){if(!e||!e.exoForm)throw"Invalid invocation of callCustomMethod";let t=e.rule.method;if(t){e.exoForm.options.customMethods[t].apply(e.exoForm,[e])}}}class Page{static scope(e){e.field._control.container.removeAttribute("data-skip")}static descope(e){e.field._control.container.setAttribute("data-skip","true")}static goto(e){return e.exoForm.gotoPage(e.rule.page)}}class Dialog{static show(e){}}class ExoControlBase{attributes={};dataProps={};static returnValueType=void 0;containerTemplate=ExoForm.meta.templates.empty;constructor(e){if(this.constructor===ExoControlBase)throw new Error("Can't instantiate abstract class!");if(this.context=e,!e||!e.field||!e.exo)throw"Invalid instantiation of ExoControlBase";this.htmlElement=DOM.parseHTML("<span/>")}set htmlElement(e){this._htmlElement=e,this.allowedAttributes=ExoFormFactory.listNativeProps(this.htmlElement)}get htmlElement(){return this._htmlElement}appendChild(e){this.htmlElement.appendChild(e)}triggerChange(e){var t=document.createEvent("HTMLEvents");t.initEvent("change",!0,!0),t.detail=e,this.htmlElement.dispatchEvent(t)}set enabled(e){let t=this.htmlElement;t.disabled=!e;let r=t.closest(".exf-ctl-cnt");r&&r.classList[e?"remove":"add"]("disabled")}acceptProperties(...e){this.acceptedProperties=e,e.forEach((e=>{void 0!==this.context.field[e]&&(this[e]=this.context.field[e])}))}get enabled(){return!this.htmlElement.disabled}async render(){for(var e in this.setProperties(),this.attributes)this._htmlElement.setAttribute(e,this.attributes[e]);for(var e in this.dataProps)this._htmlElement.setAttribute("data-"+e,this.dataProps[e]);if(this.container=DOM.parseHTML(DOM.format(this.containerTemplate,this.getContainerAttributes())),"true"===this.container.getAttribute("data-replace"))this.container=this.htmlElement;else{let e=this.container.querySelector('[data-replace="true"]');e?DOM.replace(e,this.htmlElement):this.container=this.htmlElement}return this.addEventListeners(),this.container}addEventListeners(){const e=this,t=e.context.exo,r=e.context.field;e.htmlElement.addEventListener("invalid",(o=>(console.debug("check validity on ",o.target,"submitCheck",e.submitCheck),"true"===o.target.closest("[data-page]").getAttribute("data-skip")?(console.debug("invalid event on skipped control",o.target.name),o.preventDefault(),!1):t.testValidity(o,r)))),e.htmlElement.addEventListener("change",(e=>{let t=e.target.value!=e.target.defaultValue,r=e.target.closest(".exf-ctl-cnt");r&&r.classList[t?"add":"remove"]("exf-dirty")}))}getContainerAttributes(){let e=this.context.field;return{caption:e.caption,tooltip:e.tooltip||"",class:e.containerClass||"",id:e.id+"-container"}}setProperties(){let e=this.context.field;for(var t in e){if(ExoForm.meta.properties.reserved.includes(t))continue;let r=e[t.toLowerCase()],o=t;this.allowedAttributes.includes(o)?this.attributes[o]=r:"object"==typeof r?this[o]=r:this.acceptedProperties&&this.acceptedProperties.includes(o)||(this.dataProps[o]=r)}}}class ExoElementControl extends ExoControlBase{static returnValueType=void 0;containerTemplate=ExoForm.meta.templates.empty;constructor(e){if(super(e),e.field.tagName)try{if(this.htmlElement=DOM.parseHTML("<"+e.field.tagName+"/>"),this.htmlElement.nodeName!==e.field.tagName.toUpperCase())throw"'"+e.field.tagName+"' is not a valid tagName"}catch(t){throw"Could not generate '"+e.field.tagName+"' element: "+t.toString()}}}class ExoInputControl extends ExoElementControl{containerTemplate=ExoForm.meta.templates.default;static returnValueType=String;constructor(e){super(e),this.htmlElement=DOM.parseHTML("<input />"),"hidden"===e.field.type&&(this.containerTemplate=ExoForm.meta.templates.empty)}async render(){return"email"===this.context.field.type&&this.createEmailLookup(),await super.render(),this.testDataList(),this.container}createEmailLookup(){const e=this;e.htmlElement.addEventListener("keyup",(t=>{if(13!==t.keyCode){let r=[];["@gmail.com","@outlook.com","@live.nl","@yahoo.com","@hotmail.com"].forEach((e=>{r.push(t.target.value.split("@")[0]+e)})),r.length>1&&e.createDataList(e.context.field,r)}}))}testDataList(){const e=this;let t=e.context.field;if(t.lookup)if(Array.isArray(t.lookup))e.createDataList(t,t.lookup);else{let r=r=>{let o=t.lookup.replace(".json","_"+r+".json");o=new URL(o,e.formSchema.baseUrl),fetch(o).then((e=>e.json())).then((r=>{e.createDataList(t,r)}))};Core.isValidUrl(t.lookup)||(r=e.getFetchLookup(t)),this.htmlElement.addEventListener("keyup",(e=>{r(t._control.htmlElement.value)}))}}getFetchLookup(e){const t=this,r=t.context.exo,o={field:e,type:"lookup",data:e.lookup,callback:(e,r)=>{t.createDataList.call(t,e,r)}};return"OpenData"===o.data.type?e=>{e=e.substr(0,1).toUpperCase()+e.substr(1);let t=o.data.url+"?$top=20&$filter=substring("+o.data.field+",0,"+e.length+") eq '"+e+"'";fetch(t).then((e=>e.json())).then((e=>{e&&e.value&&o.callback(o.field,e.value.map((e=>e.Title)))}))}:r.options.get(o)}createDataList(e,t){let r=e.id;e._control.htmlElement.setAttribute("list","list-"+r);let o=e._control.container.querySelector("datalist");o&&o.remove();const a=DOM.parseHTML(DOM.format(ExoForm.meta.templates.datalist,{id:"list-"+r}));t.forEach((e=>{let t={value:e,label:e.name,...e};a.appendChild(DOM.parseHTML(DOM.format(ExoForm.meta.templates.datalistItem,t)))})),e._control.container.appendChild(a)}}class ExoTextControl extends ExoInputControl{containerTemplate=ExoForm.meta.templates.text;constructor(e){super(e),this.htmlElement=DOM.parseHTML('<input type="text"/>')}async render(){var e=this.context.field;return this.attributes.placeholder||(this.attributes.placeholder=" "),await super.render(),e.mask&&DOM.maskInput(this.htmlElement,{mask:e.mask,format:e.format}),this.container}}class ExoFormControl extends ExoElementControl{constructor(e){super(e),this.htmlElement=DOM.parseHTML("<form />")}}class ExoDivControl extends ExoElementControl{constructor(e){super(e),this.htmlElement=DOM.parseHTML("<div />")}html="";async render(){return this.html&&(this.htmlElement=DOM.parseHTML(this.html)),await super.render()}}class ExoTextAreaControl extends ExoTextControl{containerTemplate=ExoForm.meta.templates.text;constructor(e){super(e),this.htmlElement=DOM.parseHTML("<textarea/>")}setProperties(){super.setProperties(),this.attributes.value&&(this.htmlElement.innerHTML=this.attributes.value,delete this.attributes.value)}}class ExoListControl extends ExoElementControl{containerTemplate=ExoForm.meta.templates.default;isMultiSelect=!1;constructor(e){super(e),this.htmlElement=DOM.parseHTML("<select></select>")}async populateList(e,t){const r=this,o=r.context.field;o.items&&Array.isArray(o.items)&&o.items.forEach((a=>{r.addListItem(o,a,t,e)}))}addListItem(e,t,r,o){const a=this;var n=DOM.parseHTML("<span/>");o.appendChild(n);let s={...t,name:t.name||t,value:void 0!==t.value?t.value:t,type:a.optionType,inputname:e.name,checked:t.checked?"checked":"",tooltip:(t.tooltip||t.name||"").replace("{{field}}","")};var i={field:e,control:a,item:s};if(s.element)i.listElement=s.element,DOM.replace(n,s.element);else if(s.field)this.renderFieldSync(s,r,o);else if(s.html)i.listElement=DOM.parseHTML(s.html),DOM.replace(n,i.listElement);else{var l=DOM.format(r,s);i.listElement=DOM.parseHTML(l),DOM.replace(n,i.listElement)}a.context.exo.triggerEvent(ExoFormFactory.events.getListItem,i)}renderFieldSync(e,t,r){return(async(e,t)=>{-1===e.name.indexOf("{{field}}")&&(e.tooltip=e.tooltip||e.name,e.name=e.name+"{{field}}");const o=this.context.exo.context;let a=await o.createForm().renderSingleControl(e.field);e.name=DOM.format(e.name,{field:a.outerHTML}),r.appendChild(DOM.parseHTML(DOM.format(t,e)))})(e,t)}}class ExoDropdownListControl extends ExoListControl{constructor(e){super(e),this.htmlElement=DOM.parseHTML('<select size="1"></select>')}async render(){let e=this.context.field;e.containerClass=(e.containerClass||"")+" exf-"+this.context.field.type+" exf-input-group";return await this.populateList(this.htmlElement,'<option class="{{class}}" value="{{value}}">{{name}}</option>'),super.render()}}class ExoInputListControl extends ExoListControl{constructor(e){super(e);this.htmlElement=DOM.parseHTML(DOM.format('<div data-evtarget="true" class="{{class}}" {{required}}>{{inner}}</div>',{class:[this.context.field.class||""].join(" ")}))}async render(){let e=this.context.field;e.containerClass=(e.containerClass||"")+" exf-"+this.context.field.type+" exf-input-group";return await this.populateList(this.htmlElement,'<label title="{{tooltip}}"><input class="{{class}}" {{checked}} name="{{inputname}}" value="{{value}}" type="{{type}}" /><span class="exf-caption">{{name}}</span></label>'),super.render(),this.container}}class ExoRadioButtonListControl extends ExoInputListControl{optionType="radio";constructor(e){super(e)}}class ExoCheckboxListControl extends ExoInputListControl{optionType="checkbox";static returnValueType=Array;constructor(e){super(e)}async render(){return await super.render(),this.context.field.getCurrentValue=()=>{let e=[];return this.container.querySelectorAll(":checked").forEach((t=>{e.push(t.value)})),e},this.container}}class ExoButtonControl extends ExoElementControl{containerTemplate=ExoForm.meta.templates.nolabel;constructor(e){super(e),this.iconHtml="",this.htmlElement=DOM.parseHTML("<button />"),this.acceptProperties("icon","click")}async render(){const e=this;e.icon&&(e.htmlElement.appendChild(DOM.parseHTML('<span class="'+e.icon+'"></span>')),this.htmlElement.appendChild(document.createTextNode(" "))),e.htmlElement.appendChild(document.createTextNode(this.context.field.caption));let t=await super.render();return e.click&&e.htmlElement.addEventListener("click",(t=>{e.context.exo.getFormValues().then((t=>{let r=e.click;if("function"!=typeof r&&(r=e.context.exo.options.customMethods[r]),"function"!=typeof r)throw"Not a valid function: "+e.click;r.apply(e,[t])}))})),t}set icon(e){this._icon=e}get icon(){return this._icon}}class ExoRangeControl extends ExoInputControl{constructor(e){super(e),this.context.field.type="range"}static returnValueType=Number}class ExoProgressControl extends ExoElementControl{containerTemplate=ExoForm.meta.templates.nolabel;constructor(e){super(e),this.htmlElement=DOM.parseHTML("<progress />")}}class ExoFormPageControl extends ExoDivControl{finalize(){}}class ExoFieldSetControl extends ExoFormPageControl{constructor(e){super(e),this.htmlElement=DOM.parseHTML(DOM.format(ExoForm.meta.templates.fieldset,e.field)),e.field.legend&&this.appendChild(DOM.parseHTML(DOM.format(ExoForm.meta.templates.legend,{legend:e.field.legend}))),e.field.intro&&this.appendChild(DOM.parseHTML(DOM.format(ExoForm.meta.templates.pageIntro,{intro:e.field.intro})))}}class ExoBaseControls{static controls={base:{hidden:!0,type:ExoControlBase},element:{type:ExoElementControl,note:"Any raw HTML Element",demo:{type:"element",tagName:"img",src:"https://source.unsplash.com/random/600x400"}},input:{hidden:!0,type:ExoInputControl},div:{hidden:!0,type:ExoDivControl,note:"A standard HTML div container element",demo:{html:"<h3>Wow!</h3>"}},form:{hidden:!0,type:ExoFormControl},formpage:{hidden:!0,type:ExoFormPageControl},fieldset:{hidden:!0,for:"page",type:ExoFieldSetControl,note:"A fieldset for grouping controls in a form"},text:{caption:"Short text",type:ExoTextControl,note:"Standard text input"},url:{caption:"Website Address/URL",base:"text",note:"A text input that will accept URLs only"},tel:{caption:"Phone number",base:"input",note:"A text input that is used to input phone numbers",demo:{value:"06 23467899"}},number:{caption:"Numeric Control",base:"text",note:"A text input that is used to input phone numbers",demo:{min:1,max:99}},range:{caption:"Range Slider",type:ExoRangeControl,note:"A range slider input",demo:{min:1,max:10,value:5}},color:{caption:"Color Input",base:"input",note:"A control to select a color",demo:{value:"#cc4433"}},checkbox:{base:"input",note:"A checkbox",demo:{checked:!0}},email:{caption:"Email Address",base:"text",note:"A text input that validates email addresses",demo:{required:!0}},date:{base:"input",note:"A date input that is used to input phone numbers"},month:{base:"input",note:"A month selector input"},"datetime-local":{caption:"Local Date &amp; Time selector",base:"input",note:"A date input that is used to input local date/time"},search:{base:"text",note:"A search text input with a clear button"},password:{base:"text",note:"A text input for password masking"},file:{caption:"File upload",base:"text",note:"A standard file upload control"},multiline:{caption:"Long text",type:ExoTextAreaControl,alias:"textarea",note:"A multi-line text input"},list:{hidden:!0,type:ExoListControl},dropdown:{type:ExoDropdownListControl,alias:"select",note:"A dropdown list control",demo:{items:["First","Second"]}},checkboxlist:{caption:"Multiselect List (checkbox)",type:ExoCheckboxListControl,note:"A group of checkboxes to select multiple items",demo:{items:["First","Second"]}},radiobuttonlist:{caption:"Single select List (radio)",type:ExoRadioButtonListControl,note:"A group of radio buttons to select a single value from",demo:{items:["First","Second"]}},hidden:{base:"input",note:"A hidden input that is used to store variables"},custom:{hidden:!0,base:"div",note:"A custom control that is used to render your own ExoFormControl classes"},button:{type:ExoButtonControl,note:"A button control",demo:{caption:"Click me"}},time:{caption:"Time selector",base:"text",note:"A time input control"},progressbar:{type:ExoProgressControl,alias:"progress",note:"A progress indicator control"}}}class ExoFileDropControl extends ExoBaseControls.controls.input.type{async render(){const e=this;return e.field=e.context.field,e.field.type="file",e.field.data=this.field.data||[],await super.render(),e.previewDiv=DOM.parseHTML('<div class="file-preview clearable"></div>'),e.container.appendChild(e.previewDiv),e.container.classList.add("exf-filedrop"),e.bind((t=>{if(t.error)alert(t.error);else{var r=DOM.parseHTML('<div data-id="'+t.fileName+'" class="thumb '+t.type.replace("/"," ")+'"></div>');let o=DOM.parseHTML('<button title="Remove" type="button" class="close">x</button>');o.addEventListener("click",(t=>{let r=t.target.closest(".thumb"),o=r.getAttribute("data-id");Array.from(e.previewDiv.children).indexOf(r),r.remove(),e.field.data=e.field.data.filter((e=>e.fileName!==o)),e._change()})),r.appendChild(o),r.setAttribute("title",t.fileName);let a=DOM.parseHTML('<div class="thumb-data"></div>');t.type.startsWith("image/")?(r.classList.add("image"),a.style.backgroundImage='url("'+e.getDataUrl(t.b64,t.type)+'")'):r.classList.add("no-img"),r.appendChild(a),r.appendChild(DOM.parseHTML("<figcaption>"+t.fileName+"</figcaption>")),e.previewDiv.appendChild(r)}})),e.field.getCurrentValue=()=>e.field.data.sort(),e.container}_change(){DOM.trigger(this.htmlElement,"change",{data:this.context.field.data})}bind(e){const t=this,r=r=>{var o=r.file,a=new FileReader;a.onload=function(){let o={error:"",fileName:r.file.name,type:r.file.type,size:r.file.size,date:r.file.lastModifiedDate};if(t.field.max&&t.field.data.length>=t.field.max&&(o.error="Maximum number of attachements reached"),t.field.fileTypes){let e=!1;t.field.fileTypes.forEach((t=>{0===r.file.type.indexOf(t)&&(e=!0)})),e||(o.error="Invalid file type")}!o.error&&t.field.maxSize&&r.file.size>t.field.maxSize&&(o.error="Max size exceeded"),o.error||(o.b64=btoa(a.result)),o.error||(t.field.data.push(o),t._change()),e(o)};try{a.readAsBinaryString(o)}catch{}},o=t.htmlElement.closest(".exf-ctl-cnt");t.htmlElement.addEventListener("change",(e=>{if(!e.detail){for(var t in e.stopImmediatePropagation(),e.cancelBubble=!0,e.preventDefault(),e.stopPropagation(),e.returnValue=!1,o.classList.remove("drag-over"),e.target.files)r({file:e.target.files[t]});return!1}})),o.addEventListener("dragover",(e=>{e.dataTransfer.dropEffect="copy",o.classList.add("drag-over")})),o.addEventListener("drop",(e=>{e.dataTransfer.dropEffect="none",o.classList.remove("drag-over")})),o.addEventListener("dragleave",(e=>{e.dataTransfer.dropEffect="none",o.classList.remove("drag-over")}))}getDataUrl(e,t){return"data:"+t+";base64,"+e}}class ExoCKRichEditor extends ExoBaseControls.controls.div.type{constructor(e){super(e),this.htmlElement.data={}}async render(){const e=this;return await super.render(),e.htmlElement,new Promise(((t,r)=>{DOM.require("https://cdn.ckeditor.com/ckeditor5/17.0.0/classic/ckeditor.js",(()=>{ClassicEditor.create(e.htmlElement).catch((e=>{console.error(e)})).then((t=>{e.htmlElement.data.editor=t,e.context.field.getCurrentValue=()=>e.htmlElement.data.editor.getData()})),t(e.container)}))}))}}class ExoSwitchControl extends ExoBaseControls.controls.range.type{containerTemplate=ExoForm.meta.templates.labelcontained;static returnValueType=Boolean;constructor(e){super(e)}setProperties(){this.context.field.min=0,this.context.field.max=1,this.context.field.containerClass="exf-switch",this.context.field.value=this.context.field.value||0,super.setProperties(),this.context.field.type="switch"}async render(){const e=this;let t=await super.render();const r=t=>{let r=t.target.closest(".exf-switch"),o=r.querySelector("[type='range']");r.classList["1"===o.value?"add":"remove"]("on"),e.triggerChange()};return r({target:t}),this.context.field.disabled&&(this.enabled=!1),t.addEventListener("click",(e=>{e.stopImmediatePropagation(),e.cancelBubble=!0,e.preventDefault(),e.stopPropagation(),e.returnValue=!1;let t=e.target.closest(".exf-switch").querySelector("[type='range']");"INPUT"!=e.target.tagName&&(t.value="0"==t.value?1:0,r({target:t})),r({target:t})})),t}}class ExoTaggingControl extends ExoBaseControls.controls.text.type{max=null;duplicate=!1;wrapperClass="exf-tags-input";tagClass="tag";arr=[];constructor(e){super(e),this.acceptProperties("max","duplicate","tags")}async render(){const e=this;return await super.render(),e.wrapper=document.createElement("div"),e.input=document.createElement("input"),e.htmlElement.setAttribute("type","hidden"),e.htmlElement.addEventListener("change",(e=>{e.detail||(e.stopImmediatePropagation(),e.cancelBubble=!0,e.preventDefault(),e.stopPropagation(),e.returnValue=!1)})),e.wrapper.append(e.input),e.wrapper.classList.add(e.wrapperClass),e.container.insertBefore(e.wrapper,e.htmlElement),e.context.field.getCurrentValue=()=>e.arr,e.wrapper.addEventListener("click",(function(){e.input.focus()})),e.input.addEventListener("keydown",(t=>{var r=e.input.value.trim();if(~[9,13,188].indexOf(t.keyCode))t.preventDefault(),t.stopPropagation(),t.returnValue=!1,e.input.value="",""!==r&&e.addTag(r);else if("Backspace"===t.key&&""===e.input.value){let t=e.wrapper.querySelectorAll(".tag");if(t.length){let r=t.length-1;e.deleteTag(t[r],r)}}})),e.tags&&e.tags.forEach((t=>{e.addTag(t)})),e.container}addTag(e){const t=this;if(!t.anyErrors(e)){t.arr.push(e);var r=document.createElement("span");r.className=this.tagClass,r.textContent=e;var o=document.createElement("a");return o.innerHTML="&times;",o.addEventListener("click",(e=>{e.preventDefault();for(var r=e.target.parentNode,o=0;o<t.wrapper.childNodes.length;o++)t.wrapper.childNodes[o]==r&&t.deleteTag(r,o)})),r.appendChild(o),t.wrapper.insertBefore(r,t.input),t.triggerChange(),t}}deleteTag(e,t){return e.remove(),this.arr.splice(t,1),this.triggerChange(),this}triggerChange(){var e=document.createEvent("HTMLEvents");e.initEvent("change",!0,!0),e.detail={field:"tags"},this.input.dispatchEvent(e)}anyErrors(e){return null!=this.max&&this.arr.length>=this.max?(console.log("Max tags limit reached"),!0):!this.duplicate&&-1!=this.arr.indexOf(e)&&(console.log('duplicate found " '+e+' " '),!0)}addData(e){var t=this;return e.forEach((function(e){t.addTag(e)})),this}}class ExoTabStripControl extends ExoBaseControls.controls.div.type{constructor(e){super(e);let t=this.context.field.name||"tabStrip",r={};this.context.field.pages.forEach((e=>{r[e.id]={caption:e.caption}})),this.tabStrip=new ULTabStrip(t,{tabs:r})}finalize(e){let t=0,r=e.querySelectorAll(".exf-page");for(var o in this.tabStrip.tabs)this.tabStrip.tabs[o].replaceWith(r[t]),t++}async render(){await super.render();let e=await this.tabStrip.render();return e.classList.add("exf-tabs-wrapper"),e}}class ExoCaptchaControl extends ExoBaseControls.controls.div.type{constructor(e){super(e),DOM.require("https://www.google.com/recaptcha/api.js"),this.acceptProperties("sitekey")}async render(){return this.htmlElement.classList.add("g-recaptcha"),this.htmlElement.setAttribute("data-sitekey",this.sitekey),this.htmlElement}set sitekey(e){this._sitekey=e}get sitekey(){return this._sitekey}}class DropDownButton extends ExoBaseControls.controls.list.type{containerTemplate=ExoForm.meta.templates.nolabel;navTemplate='\n        <nav class="ul-drop" role=\'navigation\'>\n            <ul>\n                <li>\n                    <a class="user-icon" href="#"><span class="ti-user"></span></a>\n                    <ul></ul>\n                </li>\n            </ul>\n        </nav>';constructor(e){super(e),this.context.field.type="hidden",this.htmlElement=DOM.parseHTML(this.navTemplate)}async render(){this.context.field;return await this.populateList(this.htmlElement.querySelector("ul > li > ul"),'<li title="{{tooltip}}"><a class="{{class}}" href="{{value}}">{{name}}</a></li>'),await super.render()}setupButton(){document.querySelector("body").classList.add("signed-out"),container.appendChild(DOM.parseHTML(DOM.format(tpl,data,{empty:void 0})))}}class ExoVideoControl extends ExoBaseControls.controls.list.type{width=600;height=400;mute=!1;autoplay=!0;player="youtube";tooltip="YouTube video player";id="abcdefghij";static players={youtube:{template:'<iframe width="{{width}}" height="{{height}}" src="https://www.youtube.com/embed/{{id}}?autoplay={{autoplay}}&mute={{mute}}" title="{{tooltip}}" \n                frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>'},vimeo:{template:'<iframe src="https://player.vimeo.com/video/{{id}}?title=0&byline=0&portrait=0&background={{mute}}" title="{{tooltip}}"\n                width="{{width}}" height="{{height}}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>'}};constructor(e){super(e),this.acceptProperties("width","height","autoplay","mute","id","tooltip","player")}async render(){const e=ExoVideoControl.players[this.player];if(!e)throw"Unrecognized player";return this.htmlElement=DOM.parseHTML(DOM.format(e.template,this)),this.htmlElement}}class MultiInputControl extends ExoBaseControls.controls.div.type{grid="exf-cols-50-50";constructor(e){super(e),this.acceptProperties("grid-template","grid")}async render(){const e=this,t=e.context.field;this.htmlElement.classList.add("exf-cnt","exf-ctl-group",this.grid),this["grid-template"]&&this.htmlElement.setAttribute("style","grid-template: "+this["grid-template"]),e._qs=e=>this.htmlElement.querySelector('[name="'+t.name+"_"+e+'"]');e.inputs={};const r=async(r,o)=>{e.inputs[r]=await(async(r,o)=>e.context.exo.renderSingleControl({name:t.name+"_"+r,...o}))(r,o),e.htmlElement.appendChild(e.inputs[r])};for(var o in this.fields)await r(o,this.fields[o]);return e._gc=t=>{let r={};for(var o in e.fields)r[o]=e._qs(o).value;return r},this.context.field.getCurrentValue=e._gc,e.htmlElement}}class ExoNameControl extends MultiInputControl{grid="exf-cols-10em-1fr";fields={first:{caption:"First",type:"text",maxlength:30,required:!0,placeholder:""},last:{caption:"Last",type:"text",maxlength:50,required:!0,placeholder:""}}}class ExoNLAddressControl extends MultiInputControl{grid="exf-cols-10em-1fr";"grid-template"='"a b c"\n"a b b"';static APIUrl="https://geodata.nationaalgeoregister.nl/locatieserver/v3/free?q=postcode:{{code}}&huisnummer:{{nr}}";fields={code:{caption:"Postcode",type:"text",size:7,maxlength:7,required:!0,pattern:"[1-9][0-9]{3}s?[a-zA-Z]{2}",placeholder:""},nr:{caption:"Huisnummer",type:"number",size:6,maxlength:6,placeholder:""},ext:{caption:"Toevoeging",type:"text",size:3,maxlength:3,placeholder:""},city:{caption:"Plaats",type:"text",maxlength:50,readonly:!0,placeholder:""},street:{caption:"Straatnaam",type:"text",maxlength:50,readonly:!0,placeholder:""}};async render(){const e=this;let t=await super.render();const r=()=>{var t=e._gc();t.code&&t.nr&&fetch(DOM.format(ExoNLAddressControl.APIUrl,{nr:t.nr,code:t.code}),{referer:"https://stasfpwawesteu.z6.web.core.windows.net/",method:"GET"}).then((e=>e.json())).then((t=>{var r=t.response;if(r.numFound>0){let t=r.docs[0];e._qs("street").value=t.straatnaam_verkort,e._qs("city").value=t.woonplaatsnaam}}))};return e.inputs.nr.addEventListener("change",r),e.inputs.code.addEventListener("change",r),e.inputs.ext.addEventListener("change",r),t}}class ExoCreditCardControl extends MultiInputControl{grid="exf-cols-50-50";fields={name:{caption:"Name on Card",type:"text",maxlength:50,required:!0,placeholder:""},number:{caption:"Credit Card Number",type:"text",size:16,required:!0,maxlength:16,placeholder:"",pattern:"[0-9]{13,16}"},expiry:{caption:"Card Expires",containerClass:"exf-label-sup",type:"month",required:!0,maxlength:3,placeholder:"",min:(new Date).getFullYear()+"-"+("0"+((new Date).getMonth()+1)).slice(-2)},cvv:{caption:"CVV",type:"number",required:!0,minlength:3,maxlength:3,size:3,placeholder:"",min:"000"}}}class ExoDateRangeControl extends MultiInputControl{grid="exf-cols-10em-10em";fields={from:{caption:"From",type:"date",required:!0},to:{caption:"To",type:"date",required:!0}};async render(){let e=await super.render(),t=this.inputs.from.querySelector("[name]"),r=this.inputs.to.querySelector("[name]");const o=e=>{e.target===t?r.setAttribute("min",t.value):e.target===r&&t.setAttribute("max",r.value)};return t.addEventListener("change",o),r.addEventListener("change",o),e}}class ExoDialogControl extends ExoBaseControls.controls.div.type{title="Dialog";confirmText="OK";cancelText="Cancel";cancelVisible=!1;body="The dialog body";modal=!1;dlgTemplate='<div class="exf-dlg" role="dialog" id="{{dlgId}}">\n<div class="exf-dlg-c">\n    <div class="exf-dlg-h">\n        <div class="exf-dlg-t">{{title}}<button type="button" class="dlg-bc dlg-x dismiss" ><span>&times;</span></button></div>\n    </div>\n<div class="exf-dlg-b">{{body}}</div>\n<div class="exf-dlg-f">\n    <button type="button" class="dlg-x btn btn-default dismiss" >{{cancelText}}</button>\n    <button type="button" class="dlg-x btn btn-primary confirm" >{{confirmText}}</button>\n</div>\n</div>\n</div>';constructor(e){super(e),this.acceptProperties("title","cancelText","body","confirmText","cancelVisible","modal"),this.dlgId="dlg_"+Core.guid().replace("-","")}hide(){}show(){const e=this;let t=DOM.format(e.dlgTemplate,{...this}),r=DOM.parseHTML(t);r.classList.add(this.cancelVisible?"dlg-cv":"dlg-ch");const o=(t,r)=>{e.remove();var o="cancel",a=t.target;(r||a.classList.contains("confirm"))&&(o="confirm"),e.hide.apply(e,[o])};r.querySelector(".dlg-x").addEventListener("click",o),document.body.appendChild(r),r.addEventListener("click",o),document.body.addEventListener("keydown",(e=>{27===e.keyCode&&o(e),13===e.keyCode&&o(e,!0)}),{once:!0}),this.modal||setTimeout((()=>{document.body.addEventListener("click",o,{once:!0})}),10)}remove(){let e=document.querySelector("#"+this.dlgId);e&&e.remove()}}class ExoExtendedControls{static controls={filedrop:{type:ExoFileDropControl,alias:"file",note:"An input for file uploading",demo:{drop:{height:"100px"},max:1,fileTypes:["image/"],maxSize:4096e3,caption:"Select your profile image",containerClass:"image-upload"}},switch:{type:ExoSwitchControl},richtext:{type:ExoCKRichEditor,note:"A CKEditor wrapper for ExoForm"},tags:{caption:"Tags control",type:ExoTaggingControl,note:"A control for adding multiple tags",demo:{tags:["JavaScript","CSS","HTML"]}},creditcard:{caption:"Credit Card",type:ExoCreditCardControl,note:"A credit card control"},name:{caption:"Name (first, last) group",type:ExoNameControl,note:"Person name controk"},nladdress:{caption:"Dutch address",type:ExoNLAddressControl,note:"Nederlands adres"},tabstrip:{for:"page",type:ExoTabStripControl,note:"A tabstrip control for grouping controls in a form"},daterange:{caption:"Date range",type:ExoDateRangeControl,note:"A date range control"},video:{type:ExoVideoControl,caption:"Embed video",note:"An embedded video from YouTube or Vimeo",demo:{player:"youtube",id:"85Nyi4Xb9PY"}},dropdownbutton:{hidden:!0,type:DropDownButton,note:"A dropdown menu button"},captcha:{caption:"Google ReCaptcha Control",type:ExoCaptchaControl,note:"Captcha field",demo:{sitekey:"6Lel4Z4UAAAAAOa8LO1Q9mqKRUiMYl_00o5mXJrR"}},dialog:{type:ExoDialogControl,caption:"Dialog",note:"A simple dialog (modal or modeless)"}}}class ExoAceCodeEditor extends ExoBaseControls.controls.div.type{mode="html";theme="chrome";constructor(e){super(e),this.htmlElement.data={},document.querySelector("html").classList.contains("theme-dark")&&(this.theme="ambiance")}async render(){const e=this;return await super.render(),e.htmlElement,e.context.field.getCurrentValue=()=>e.htmlElement.data.editor.getValue(),e.context.field.setCurrentValue=t=>{e.htmlElement.data.editor.setValue(t,-1)},new Promise(((t,r)=>{DOM.require("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js",(()=>{var r=ace.edit(e.htmlElement);r.setTheme("ace/theme/"+e.theme),r.session.setMode("ace/mode/"+e.mode),e.htmlElement.style="min-height: 200px; width: 100%","string"==typeof e.value&&e.value.length&&r.setValue(e.value,-1),e.htmlElement.setAttribute("data-evtarget","true"),r.on("change",(t=>{setTimeout((()=>{DOM.trigger(e.htmlElement,"change",{target:e.htmlElement})}),10)})),e.htmlElement.data.editor=r,t(e.container)}))}))}setProperties(){this.context.field.mode&&(this.mode=this.context.field.mode,delete this.context.field.mode),this.context.field.theme&&(this.theme=this.context.field.theme,delete this.context.field.theme),this.context.field.value&&(this.value=this.context.field.value,delete this.context.field.value),super.setProperties()}}class ExoMonacoCodeEditor extends ExoBaseControls.controls.div.type{mode="html";theme="vs-light";async render(){const e=this;return await super.render(),e.context.field.setCurrentValue=t=>{e.context.field.value=t,Core.waitFor((()=>e.htmlElement.data&&e.htmlElement.data.editor),1e3).then((()=>{e.htmlElement.data.editor.getModel().setValue(t)}))},e.context.field.getCurrentValue=()=>{let t=this.context.field.value;return e.htmlElement.data.editor&&(t=e.htmlElement.data.editor.getModel().getValue()),t},new IntersectionObserver(((t,r)=>{e.htmlElement.parentNode.offsetHeight&&e.initMonacoEditor()}),{root:document.documentElement}).observe(e.htmlElement),e.htmlElement}initMonacoEditor(){const e=this;if(e.isInitalized)return;const t=e.htmlElement;t.style="min-height: 200px; width: 100%",DOM.require("https://unpkg.com/monaco-editor@0.8.3/min/vs/loader.js",(()=>{require.config({paths:{vs:"https://unpkg.com/monaco-editor@0.8.3/min/vs"}}),window.MonacoEnvironment={getWorkerUrl:()=>r};let r=URL.createObjectURL(new Blob(["\n                    self.MonacoEnvironment = {\n                        baseUrl: 'https://unpkg.com/monaco-editor@0.8.3/min/'\n                    };\n                    importScripts('https://unpkg.com/monaco-editor@0.8.3/min/vs/base/worker/workerMain.js');\n                "],{type:"text/javascript"}));require(["vs/editor/editor.main"],(function(){let r=monaco.editor.create(t,{value:e.value||"",language:e.mode,theme:e.theme});t.data.editor=r,e.isInitalized=!0,r.addListener("didType",(()=>{e.value=r.getValue(),DOM.trigger(t,"change",{target:t})}))}))}))}setProperties(){this.context.field.mode&&(this.mode=this.context.field.mode,delete this.context.field.mode),this.context.field.theme&&(this.theme=this.context.field.theme,delete this.context.field.theme),this.context.field.value&&(this.value=this.context.field.value,delete this.context.field.value),super.setProperties()}}class ExoDevControls{static controls={aceeditor:{type:ExoAceCodeEditor,note:"Ace code editor",demo:{mode:"html"}},monacoeditor:{type:ExoMonacoCodeEditor,note:"Monaco - Visual Studio Code - editor",demo:{mode:"html",theme:"vs-light",value:"<html>\n</html>"}}}}class ExoCircularChart extends ExoBaseControls.controls.div.type{value="0";size="200";color="#00acc1";constructor(e){super(e),this.acceptProperties("value","size","color","backgroundColor","textColor","subLineColor","caption")}async render(){const e=this.htmlElement;let t=await super.render();return e.appendChild(DOM.parseHTML(DOM.format('<svg class="circle-chart" viewbox="0 0 33.83098862 33.83098862" width="{{size}}" height="{{size}}" xmlns="http://www.w3.org/2000/svg">\n            <circle class="circle-chart__background" stroke="{{backgroundColor}}" stroke-width="2" fill="none" cx="16.91549431" cy="16.91549431" r="15.91549431" />\n            <circle class="circle-chart__circle" stroke="{{color}}" stroke-width="2" stroke-dasharray="{{value}},100" stroke-linecap="round" fill="none" cx="16.91549431" cy="16.91549431" r="15.91549431" />\n            <g class="circle-chart__info">\n              <text class="metric chart-pct" x="16.91549431" y="15.5" alignment-baseline="central" text-anchor="middle" font-size="8" >{{value}}%</text>\n              <text class="metric chart-sub" x="16.91549431" y="20.5" alignment-baseline="central" text-anchor="middle" font-size="2" >{{caption}}</text>\n            </g>\n          </svg>',this))),t}}class ExoChartControls{static controls={circularchart:{type:ExoCircularChart,note:"Simple circular chart (SVG)",demo:{mode:"html"}}}}class ExoFormNavigationBase{buttons={};constructor(e){this.exo=e,this._visible=!0}get visible(){return this._visible}set visible(e){this._visible=e,this.exo.form.querySelector(".exf-nav-cnt")&&DOM[this._visible?"show":"hide"]()}clear(){let e=this.exo.form.querySelector(".exf-nav-cnt");e&&e.remove()}render(){for(var e in this.container=DOM.parseHTML('<fieldset class="exf-cnt exf-nav-cnt"></fieldset>'),this.buttons)this.addButton(e,this.buttons[e]);this.exo.form.appendChild(this.container)}addButton(e,t){t={class:"",type:"button",caption:e,name:e,...t||{}};let r=DOM.parseHTML(DOM.format('<button name="{{name}}" type="{{type}}" class="btn {{class}}">{{caption}}</button>',t));this.buttons[e].element=r,this.container.appendChild(r)}update(){}}class ExoFormNoNavigation extends ExoFormNavigationBase{next(){this.exo.updateView(1)}back(){this.exo.updateView(-1)}restart(){this.exo.updateView(0,1)}}class ExoFormDefaultNavigation extends ExoFormNoNavigation{buttons={send:{caption:"Submit",class:"form-post"}};render(){const e=this;super.render(),this.buttons.send.element.addEventListener("click",(t=>{t.preventDefault(),e.exo.submitForm()}))}}class ExoFormWizardNavigation extends ExoFormDefaultNavigation{buttons={prev:{caption:"Back",class:"form-prev"},next:{caption:"Next ",class:"form-next"},send:{caption:"Submit",class:"form-post"}};render(){const e=this;super.render(),this.buttons.prev.element.addEventListener("click",(t=>{t.preventDefault(),e.back()})),this.buttons.next.element.addEventListener("click",(t=>{t.preventDefault(),e.next()})),e.exo.on(ExoFormFactory.events.page,(t=>{let r=t.detail.page,o=t.detail.pageCount;DOM[1===r?"disable":"enable"](e.buttons.prev.element),DOM[r===o?"disable":"enable"](e.buttons.next.element)}))}}class ExoFormSurveyNavigation extends ExoFormWizardNavigation{render(){const e=this;super.render();e.exo.form.querySelector(".exf-wrapper").addEventListener("change",(t=>{console.log("Element "+t.type+" event fired on ",t.target,t);let r=t.target.closest("[data-exf]");r&&r.data&&r.data.field&&(console.log("check whether to move forward"),e.checkForward(r.data.field,"change",t))})),e.exo.form.addEventListener("keydown",(t=>{if(8===t.keyCode)(""===t.target.value&&!t.target.selectionStart||0===t.target.selectionStart)&&(e.exo.updateView(-1),t.preventDefault(),t.returnValue=!1);else if(13===t.keyCode){if("textarea"!==t.target.type)if(!e.exo.form.reportValidity||e.exo.form.reportValidity()){let r=t.target.closest("[data-exf]");r&&r.data&&r.data.field&&(e.checkForward(r.data.field,"enter",t),t.preventDefault(),t.returnValue=!1)}}})),e.exo.on(ExoFormFactory.events.page,(t=>{e.exo.focusFirstControl()}));let t=e.exo.form.closest(".exf-container");e.exo.on(ExoFormFactory.events.interactive,(r=>{e.exo.form.style.height=t.offsetHeight+"px",e.exo.form.querySelectorAll(".exf-page").forEach((e=>{e.style.height=t.offsetHeight+"px"})),console.log("Interactive: form height: "+e.exo.form.style.height)}))}checkForward(e,t,r){const o=this.exo;if(o.container&&(o.container.classList.remove("end-reached"),o.container.classList.remove("step-ready"),!e._control.htmlElement.reportValidity||e._control.htmlElement.reportValidity()||!o.formSchema.multiValueFieldTypes.includes(e.type)))if(o.currentPage==o.getLastPage())o.container.classList.add("end-reached"),o.form.appendChild(o.container.querySelector(".exf-nav-cnt"));else{let t=e.type;r.detail&&r.detail.field&&(t=r.detail.field),["checkboxlist","tags"].includes(t)?o.container.classList.add("step-ready"):o.updateView(1),e._control.container.appendChild(o.container.querySelector(".exf-nav-cnt"))}}}class ExoFormContext{constructor(e){this.library=e}createForm(e){return new ExoForm(this,e)}get(e){return this.library[e]}query(e){for(var t in this.library){var r=this.library[t];if(e.apply(this,[r]))return r}}isExoFormControl(e){return this.get(e.type).type.prototype instanceof ExoFormFactory.library.base.type}renderSingleControl(e){return this.createForm().renderSingleControl(e)}}class ExoFormFactory{static _ev_pfx="exf-ev-";static events={page:ExoFormFactory._ev_pfx+"page",getListItem:ExoFormFactory._ev_pfx+"get-list-item",post:ExoFormFactory._ev_pfx+"post",renderStart:ExoFormFactory._ev_pfx+"render-start",renderReady:ExoFormFactory._ev_pfx+"render-ready",change:ExoFormFactory._ev_pfx+"change",schemaLoaded:ExoFormFactory._ev_pfx+"form-loaded",interactive:ExoFormFactory._ev_pfx+"form-interactive"};static navigation={none:ExoFormNoNavigation,default:ExoFormDefaultNavigation,wizard:ExoFormWizardNavigation,survey:ExoFormSurveyNavigation};static Context=ExoFormContext;static defaults={imports:[]};static html={classes:{formContainer:"exf-container",pageContainer:"exf-page",elementContainer:"exf-ctl-cnt"}};static library={};static build(e){return e=e||{},new Promise(((t,r)=>{var o=[];e.imports=e.imports||this.defaults.imports,e.add&&e.imports.push(...e.add),this.add(ExoBaseControls.controls),this.add(ExoExtendedControls.controls),this.add(ExoDevControls.controls),this.add(ExoChartControls.controls),e.imports.forEach((e=>{o.push(ExoFormFactory.loadLib(e))})),Promise.all(o).then((()=>{let r=ExoFormFactory.buildLibrary();console.debug("ExoFormFactory loaded library",r,"from",e.imports),t(new ExoFormContext(r))}))}))}static buildLibrary(){for(var e in ExoFormFactory.library){var t=ExoFormFactory.library[e];t.typeName=e,t.type=this.lookupBaseType(e,t),t.isList=t.type.prototype instanceof ExoFormFactory.library.list.type,t.isList&&(t.isMultiSelect=t.type.isMultiSelect),t.returnValueType=t.type.returnValueType,["date"].includes(t.typeName)&&(t.returnValueType=Date)}return ExoFormFactory.library}static lookupBaseType(e,t){let r=t.type;for(;void 0===r&&t.base;)(t=this.library[t.base])||console.error("Invalid base type",t.base),r=t.type,r.prototype instanceof ExoFormFactory.library.base.type||console.error("Class for "+e+" is not derived from ExoControlBase");return r}static async loadLib(e){let t=(await import(e)).default;this.add(t.controls)}static add(e){for(var t in e){var r=e[t];ExoFormFactory.library[t]=r}}static listNativeProps(e){let t=e.__proto__,r=Object.getOwnPropertyNames(t),o=["style","class","accesskey","contenteditable","dir","disabled","hidefocus","lang","language","tabindex","title","unselectable"," xml:lang"];return r.forEach((e=>{void 0!==Object.getOwnPropertyDescriptor(t,e).set&&o.push(e.toLowerCase())})),o}static loadCustomControl(e,t){return ExoFormFactory.importType(t)}static async importType(e){return await import(e)}static checkTypeConversion(e,t){let r,o=ExoFormFactory.library[e];if(o)try{r=ExoFormFactory.getTypeParser(o)(t),r!==t&&console.debug("Value '",t,"' for field",e," converted to",r,typeof r)}catch(e){console.error("Error converting '"+r+"'to "+o.returnValueType,e)}return r}static getTypeParser(e){switch(e.returnValueType){case Number:return Number.parseFloat;case Date:return ExoFormFactory.parseDate;case Boolean:return ExoFormFactory.parseBoolean;default:return e=>e}}static parseDate(e){let t=Date.parse(e);return isNaN(t)?t:new Date(t).toJSON()}static parseBoolean(e){return parseInt(e)>0||"1"===e||"true"===e||"on"===e}static getFieldFromElement(e){let t=null;return e.getAttribute("data-exf")?t=e.data.field:e.classList.contains("exf-ctl-cnt")?(e=e.querySelector("[data-exf]"))&&(t=e.data.field):(e=e.closest("[data-exf]"))&&(t=e.data.field),t}static fieldToString(e){if(e){let t=e.type||"unknown type";if(e.isPage)return"Page "+e.index+" ("+t+")";if(e.name||e.id&&e.elm)return"Field '"+(e.name||e.id)+"' ("+t+")"}return"Unknown field"}}class ServiceWorker{constructor(){}}class Router{modules=[];constructor(e,t,r){const o=this;o.app=e,o.routes=t,o.setupHashListener(r.onRoute),console.debug("Loading Route modules"),o.loadModules().then((()=>{console.debug("Loaded Route modules",o.modules),DOM.trigger(window,"hashchange")})).then((()=>{console.debug("Router Ready"),r.ready()}))}static changeHash(e){history.replaceState(null,null,document.location.pathname+"#"+e)}setupHashListener(e){this.routeCallback=e;const t=this;window.addEventListener("hashchange",(()=>{t.hashChanged()}))}hashChanged(){const e=this,t=window;var r=t.location.hash.substr(1);if(r.startsWith("/")){let o="/"+r.substr(1).split("/")[0],a=r.substr(o.length),n=e.routes[o];if(console.debug(t.location.hash,"RouteModule: ",n),n){let t=e.findByRoute(n);if(t&&t.module){e._route=o;let r=document.querySelector("html");r.classList.forEach((e=>{e.startsWith("route-")&&r.classList.remove(e)})),document.querySelector("html").classList.add("route-"+t.module.constructor.name),e.current&&e.current.module._unload(),e.current=t,e.routeCallback(t.module,a)}}else r.startsWith("dlg-")||e.home()}else e.home()}set route(e){if(!this.routes[e])throw"Unknown route: "+e;Router.changeHash(e),this.hashChanged()}get route(){return this._route}findByRoute(e){return this.modules.find((t=>t.route===e))}findById(e){return this.modules.find((t=>t.path===e))}loadModules(){const e=this;let t=[],r=!1;for(var o in e.routes){"/"===o&&(r=!0);let a=e.routes[o];if(!o.startsWith("/"))throw"Malformed route: "+o;t.push(new Promise(((t,r)=>{e.loadES6Module(a,e.app,a,o).then((e=>{t(e)}))})))}if(!r)throw"Router misconfiguration: no home (/) route found";return Promise.all(t).then((t=>{t.forEach((t=>{e.modules.push({...t,route:t.route,url:"#"+t.path,module:t})}))}))}loadES6Module(e){e=new URL(e,this.app.config.baseUrl);let t=Array.prototype.slice.call(arguments,1);return(async e=>{try{return await import(e)}catch(t){throw"Could not load "+e+": "+t}})(e).then((e=>new(0,e.default)(...t)))}home(){this.route="/"}generateMenu(e){const t=this;let r=[];t.modules.forEach((e=>{if(!e.hidden){let t={...e};t.menuTitle=t.menuTitle||e.title;let o=DOM.format('<li class="{{menuClass}}" title="{{title}}"><a href="{{url}}"><span class="{{menuIcon}}"></span> <span class="name">{{menuTitle}}</span></a></li>',t,{empty:void 0});r.push(o)}}));let o=DOM.format('<nav class="main-menu"><ul>{{inner}}</ul></nav>',{inner:r.join("")});return e.add(DOM.parseHTML(o)),e.element.addEventListener("click",(e=>{const t=this;e.target.closest("li")&&(t.app.UI.areas.menu.element.classList.add("clicked"),this.touchStarted||setTimeout((()=>{t.app.UI.areas.menu.element.classList.remove("clicked"),t.touchStarted=!1}),1500))})),e.element.addEventListener("touchstart",(e=>{this.touchStarted=!0,e.target.closest("li")?e.target.closest(t.config.areas.menu).classList.add("clicked"):e.target.closest(t.config.areas.menu).classList.remove("clicked")})),e}}class RouteModule{title="Module";menuIcon="ti-test";constructor(e,t,r){if(this.route=t,this.app=e,this.path=r,!e)throw"RouteModule constructor parameter 'app' not defined";if(!e.config)throw"app.config not defined"}_unload(){document.head.querySelectorAll("[data-pwa]").forEach((e=>{e.remove()})),this.unload()}unload(){}async asyncInit(){return Promise.resolve()}execute(){const e=this;e.asyncInit().then((()=>{e._init(),e.app.UI.areas.title.set(e.title),e.render(...arguments)}))}render(){}_init(){const e=this;for(var t in e.app.UI.areas)e.app.UI.areas[t].empty=!1}}class Area{constructor(e,t){this.name=e;this.element=t,this.checkPinnable()}add(e){if(e)try{"string"==typeof e&&(e=-1===e.indexOf("<")?DOM.parseHTML("<span>"+e+"</span>"):DOM.parseHTML(e)),this.element.appendChild(e)}catch(t){throw"Area.add failed for "+e+". "+t.toString()}}set(e){this.element.innerHTML=e}clear(){this.set("")}checkPinnable(){const e=this;e.element.classList.contains("pwa-pinnable")&&(e.element.addEventListener("mouseover",(t=>{t.offsetX>e.element.offsetWidth-70&&t.offsetY<70?(e.pinActive=!0,e.element.classList.add("pin-active")):e.pinActive&&(e.pinActive=!1,e.element.classList.remove("pin-active"))})),e.element.addEventListener("click",(t=>{e.pinActive&&(e.pinned=!e.pinned)})))}get pinned(){return this.element.classList.contains("pinned")}set pinned(e){this.element.classList[e?"add":"remove"]("pinned"),e||this.element.classList.remove("pin-active")}set busy(e){e?this.element.classList.add("pwa-loading"):this.element.classList.remove("pwa-loading")}get busy(){this.element.classList.add("pwa-loading")}set empty(e){clearTimeout(this.rtimer),clearTimeout(this.atimer),e?(this.element.classList.remove("remove"),this.rtimer=setTimeout((()=>{this.element.classList.remove("add")}),100),this.element.classList.add("pwa-empty-state","add")):(this.element.classList.add("remove"),this.rtimer=setTimeout((()=>{this.element.classList.remove("pwa-empty-state","remove")}),500))}get empty(){return this.element.classList.includes("pwa-empty-state")}}class PWA{static RouteModule=RouteModule;static Router=Router;static ServiceWorker=ServiceWorker;defaults={UI:{allowUserSelection:!1},serviceWorker:{src:null}};constructor(e){const t=this;document.querySelector("html").classList.add("pwa-signin-pending"),this.config={...this.defaults,...e||{}},this.config.baseUrl=document.location.origin,console.debug("Checking for serviceWorker in config: serviceWorker.src"),t.config.serviceWorker.src&&t.registerWorker(t.config.serviceWorker),console.debug("PWA Config",this.config),this.asyncInit().then((()=>{this.UI=new UI(this),t.init(),t.execute()}));let r=document.querySelector("html").classList;this.forceTheme=r.contains("theme-dark")?"dark":r.contains("theme-light")?"light":void 0}registerWorker(e){console.debug("Register PWA ServiceWoker..."+e.src),"serviceWorker"in navigator&&navigator.serviceWorker.register(e.src).then((function(e){console.debug("Registration successful, scope is:",e.scope)})).catch((function(e){console.log("Service worker registration failed, error:",e)}))}init(){}asyncInit(){return Promise.resolve()}execute(e){const t=this;this.setupUI(),t.router=new Router(t,this.config.routes,{onRoute:(e,t)=>{console.debug("PWA Executes Route",e,t),e.execute(t)},ready:()=>{console.debug("PWA Router Ready"),t.routerReady()}})}rest(e,t){e=new URL(e,this.config.baseUrl);const r={method:"GET",...t||{}};return this.getToken().then((t=>{if(t&&t.accessToken){const e=new Headers;e.append("Authorization","Bearer "+t.accessToken),r.headers=e}else console.warn("No JWT Token provided. Continuing anonymously");return fetch(e,r).then((e=>e.json()))}))}get signedIn(){return null!=window.account}getToken(){return Promise.resolve()}setupUI(){}routerReady(){}}class Notifications{constructor(e){this.UI=e}add(e,t){t=t||{type:"info"},e?"string"!=typeof e&&(e=e.toString()):e="An unknown error has occurred";let r=DOM.parseHTML(DOM.format('\n            <div class="pwa-notif pwa-{{type}}">\n                <div class="pwa-cnt">\n                    <span>{{msg}}</span>\n                    <div class="pwa-notif-btns"></div>\n                    <progress value="100" max="100"></progress>\n                </div>\n            </div>\n        ',{type:t.type,msg:e}));if(t.buttons){let e=r.querySelector(".pwa-notif-btns");for(var o in t.buttons){let r=t.buttons[o],a=DOM.parseHTML(DOM.format('<button class="btn">{{caption}}</button>',r));e.appendChild(a),a.addEventListener("click",(e=>{e.stopPropagation(),r.click(e)}))}}r.addEventListener("click",(()=>{r.remove()}));const a=t.timeout||2e3+200*e.split(" ").length;document.body.appendChild(r);let n=r.querySelector("progress");n.setAttribute("value","100");var s,i=100;s=setInterval((()=>{i--,n.setAttribute("value",i.toString()),i<=0&&clearInterval(s)}),a/100),setTimeout((()=>{r.classList.add("move-out"),setTimeout((()=>{r.remove()}),2e3)}),a)}}class UI{_dirtyMessage="If you continue your changes will not be saved.";_dirty=!1;areas={};notifications=new Notifications(this);constructor(e){const t=this;this.pwa=e,this.html=document.querySelector("html"),this.pwa.id&&this.html.setAttribute("id",this.pwa.id),this.pwa.config.UI.user={prefersDarkScheme:!!window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,currentTheme:localStorage.getItem("theme")||"light"},this.pwa.config.UI.allowUserSelection||this.html.classList.add("no-user-select"),this.forceTheme?this.theme=this.forceTheme:void 0===this.pwa.config.UI.user.currentTheme?this.theme=this.pwa.config.UI.user.prefersDarkScheme?"dark":"light":this.theme=this.pwa.config.UI.user.currentTheme,window.addEventListener("beforeunload",(function(e){e.preventDefault(),t.dirty?e.returnValue="":delete e.returnValue})),this._setAreas()}set dirty(e){this._dirty=!0}get dirty(){return this._dirty}_setAreas(){let e=document.querySelectorAll("[data-pwa-area]");if(!e.length)throw"No PWA areas defined";e.forEach((e=>{var t=e.getAttribute("data-pwa-area");this.areas[t]=new Area(t,e)}))}get theme(){return this._theme||"light"}set theme(e){this._theme=e;let t=document.querySelector("head > meta[name='color-scheme']");t?(t.setAttribute("content",e),localStorage.setItem("theme",e),document.querySelector("html").classList.remove("theme-dark","theme-light"),document.querySelector("html").classList.add("theme-"+e)):console.warn("Theming depends on meta[name='color-scheme']")}addStyleSheet(e){DOM.addStyleSheet(e,{"data-pwa":this.pwa.router.current.path})}}class ExoRouteModule extends PWA.RouteModule{async asyncInit(){this.exoContext=await ExoFormFactory.build()}}class ExoWizardRouteModule extends ExoRouteModule{title="Wizard";menuIcon="ti-wand";formLoaded(){}wizardRendered(){}post(e){alert(JSON.stringify(e,null,2))}event(e){}unload(){this.app.UI.areas.main.clear();let e=document.querySelector(".exf-wiz-step-cnt");e&&e.remove(),document.body.classList.remove("exf-fs-progress")}render(){const e=this;e.engine=e.exoContext.createForm().on(ExoFormFactory.events.post,(t=>{e.post(t.detail.postData)}));let t=new URL(e.wizardSettings.url,e.app.config.baseUrl).toString();e.engine.load(t).then((t=>{e.formLoaded(),t.addEventListener(ExoFormFactory.events.page,(t=>{DOM.changeHash(e.path+"/page/"+t.detail.page)})),t.renderForm().then((t=>{console.log("Ready rendering wizard"),e.app.UI.areas.main.clear(),e.app.UI.areas.main.add(t.container),e.wizardRendered(t)}))}))}}class MsIdentity{options={mode:"redirect",libUrl:"https://alcdn.msauth.net/browser/2.7.0/js/msal-browser.js",msal:{auth:{clientId:"<clientid>",authority:"<authority>",redirectUri:document.URL.split("#")[0]},cache:{cacheLocation:"localStorage",storeAuthStateInCookie:!1},system:{loggerOptions:{loggerCallback:(e,t,r)=>{if(!r)switch(e){case msal.LogLevel.Error:return void console.error(t);case msal.LogLevel.Info:return void console.info(t);case msal.LogLevel.Verbose:return void console.debug(t);case msal.LogLevel.Warning:return void console.warn(t)}}}},loginRequest:{scopes:["User.Read"]},tokenRequest:{scopes:["User.Read"],forceRefresh:!1}}};constructor(e){e=e||{},this.options={...this.options,...e}}async load(){const e=this;return await new Promise(((t,r)=>{e.require(e.options.libUrl,(r=>{console.debug(e.options.libUrl,"loaded"),e.init(),t(this)}))}))}require(e,t){var r=document;r.querySelectorAll("head");let o=r.createElement("script");o.src=e,r.head.appendChild(o),o.onload=t}static trigger(e){let t=new Event("msid");t.detail=e,document.body.dispatchEvent(t)}init(){var e=this;e.myMSALObj=new msal.PublicClientApplication(e.options.msal),"popup"!==e.options.mode&&e.myMSALObj.handleRedirectPromise().then((t=>{e.handleResponse(t)})).catch((e=>{console.error(e)})),e.getAccount()}signIn(e){var t=this;t.getAccount()||("popup"===t.options.mode?t.myMSALObj.loginPopup(t.options.msal.loginRequest).then((e=>{null!==e&&(t.account=e.account,t.signedIn())})).catch((e=>{console.error(e)})):t.myMSALObj.loginRedirect(t.options.msal.loginRequest))}signedIn(){MsIdentity.trigger({type:"signedIn",account:this.account,mode:this.options.mode})}signOut(){var e=this;e.account&&e.myMSALObj.logout({account:e.myMSALObj.getAccountByUsername(e.account.username)}).then((()=>{MsIdentity.trigger({type:"signedOut",account:e.account,mode:e.options.mode})}))}getAccount(){var e=this;const t=e.myMSALObj.getAllAccounts();if(0===t.length)return null;if(t.length>1)throw"Multiple accounts detected.";1===t.length&&(e.account=t[0],e.signedIn())}getJWT(e){const t=this,r=t.options.msal.tokenRequest;return t.waitForInit().then((()=>{if(!e)throw"No user signed in";return r.account=t.myMSALObj.getAccountByUsername(e),t.myMSALObj.acquireTokenSilent(r).catch((e=>{if(e instanceof msal.InteractionRequiredAuthError)return t.myMSALObj.acquireTokenRedirect(r);console.warn(e)}))}))}waitForInit(){const e=e=>new Promise((t=>setTimeout(t,e)));return this.myMSALObj?e(1):e(200)}handleResponse(e){var t=this;null!==e&&(t.account=e.account,t.isBusy()||t.signedIn())}isBusy(){return this.myMSALObj.interactionInProgress()}}window.xo={core:Core,dom:DOM,pwa:PWA,route:ExoRouteModule,form:{factory:ExoFormFactory,fields:{base:ExoBaseControls},wizard:ExoWizardRouteModule},identity:{msal:MsIdentity}}}));
